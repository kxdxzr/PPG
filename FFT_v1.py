import pandas as pd
import matplotlib.pyplot as plt
import numpy as np
from numpy.fft import fft, ifft

def FFT(pulse_rate, sample_rate):

    #Create a list of the most recent data from the last 15 seconds
    number_samples = sample_rate*15
    number_samples = round(number_samples)
    moving_pulse_rate = pulse_rate[-number_samples:]

    # remove DC offset from PPG data
    moving_pulse_rate_array = np.array(moving_pulse_rate)
    moving_pulse_rate_array = moving_pulse_rate_array - moving_pulse_rate_array.mean()

    # calculate FFT
    fft_PPG = fft(moving_pulse_rate)
    fft_y = np.abs(fft_PPG)
    N = len(fft_PPG)
    n = np.arange(N)
    T = N/sample_rate
    freq = n/T 

    # clunky bandpass filter using FFT data
    min_freq = 0.5
    max_freq = 10
    x_data, y_data = np.array([]), np.array([])
    for i in range(len(freq)):
        if min_freq <= freq[i] <= max_freq:
            x_data = np.append(x_data, freq[i])
            y_data = np.append(y_data, fft_y[i])

    # Get BPM
    bpm_freq = x_data[y_data.argmax()]
    bpm_point = np.array([bpm_freq, max(y_data)])

    return bpm_point


##Example
example_pulse_rate = [1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.219512195, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.19047619, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698, 1.162790698]
bpm_point = FFT(example_pulse_rate, 50)
print(bpm_point)



